import sqlite3


class Database:
    def __init__(self, db_name):
        self.connection = sqlite3.connect(db_name)
        self.cursor = self.connection.cursor()
        self.create_db()
        self.populate_questions()

    # Создаём базу данных
    def create_db(self):
        self.create_users_table()
        self.create_questions_table()

    # Создаём таблицу с пользователями
    def create_users_table(self):
        query = '''CREATE TABLE IF NOT EXISTS users (
                    user_id INTEGER PRIMARY KEY UNIQUE,
                    status TEXT,
                    passed INTEGER,
                    fio TEXT,
                    class INTEGER,
                    first_question TEXT,
                    second_question TEXT,
                    third_question TEXT,
                    fourth_question TEXT,
                    fifth_question TEXT,
                    sixth_question TEXT,
                    seventh_question TEXT,
                    eighth_question TEXT,
                    ninth_question TEXT,
                    tenth_question TEXT,
                    result INTEGER
                )'''
        self.execute_query(query)

    # Создаём таблицу с вопросами
    def create_questions_table(self):
        query = '''CREATE TABLE IF NOT EXISTS questions (
                    id INTEGER PRIMARY KEY,
                    number INTEGER,
                    question TEXT,
                    answer1 TEXT,
                    answer2 TEXT,
                    answer3 TEXT,
                    answer4 TEXT,
                    correct_answer TEXT,
                    category INTEGER
                )'''
        self.execute_query(query)

    def execute_query(self, query):
        try:
            self.cursor.execute(query)
            self.connection.commit()
        except sqlite3.Error as Error:
            print('Ошибка при выполнении запроса:', Error)

    # Добавление пользователя в базу данных
    def add_user(self, user_id, status, passed):
        query = "INSERT OR IGNORE INTO users (user_id, status, passed) VALUES (?, ?, ?)"
        try:
            self.cursor.execute(query, (user_id, status, passed))
            self.connection.commit()
            if self.cursor.rowcount == 0:
                print("Пользователь уже существует в базе данных")
            else:
                print("Пользователь успешно добавлен")
        except sqlite3.Error as Error:
            print('Ошибка при добавлении пользователя:', Error)

    def populate_questions(self):
        # Вставка вопросов в таблицу с соответствующими категориями
        questions_base = [
            {
                'id': 1,
                'number': 1,
                "question": "Что такое право?",
                "answers": ["Набор правил, которые нужно соблюдать",
                            "Система законов и правил, которые регулируют поведение людей",
                            "Совокупность личных прав и обязанностей каждого человека",
                            "Способность делать всё, что хочется"],
                "correct_answer": "Система законов и правил, которые регулируют поведение людей",
                "category": 1
            },
            {
                'id': 2,
                'number': 2,
                "question": "Какие права и обязанности есть у детей?",
                "answers": ["Право на образование и обязанность учиться",
                            "Право на игру и обязанность играть",
                            "Право на свободу и обязанность быть свободным",
                            "Право на голосование и обязанность выкидывать мусор"],
                "correct_answer": "Право на образование и обязанность учиться",
                "category": 1
            },
            {
                'id': 3,
                'number': 3,
                "question": "Что такое закон и зачем он нужен?",
                "answers": ["Набор правил, которые нужно соблюдать",
                            "Система законов и правил, которые регулируют поведение людей",
                            "Совокупность личных прав и обязанностей каждого человека",
                            "Способность делать все, что хочется"],
                "correct_answer": "Система законов и правил, которые регулируют поведение людей",
                "category": 1
            },
            {
                'id': 4,
                'number': 4,
                "question": "Какие правила поведения в школе ты знаешь?",
                "answers": ["Не бегать по коридорам,\nНе драться",
                            "Не кричать на уроках,\nНе брать чужие вещи",
                            "Не курить в школе,\nНе приходить в школу в грязной одежде",
                            "Все варианты ответов верны"],
                "correct_answer": "Все варианты ответов верны",
                "category": 1
            },
            {
                'id': 5,
                'number': 5,
                "question": "Что такое личная собственность и как ее нужно уважать?",
                "answers": ["Личная собственность - это вещи, которые принадлежат человеку",
                            "Личная собственность - это вещи, которые можно брать без разрешения",
                            "Личная собственность - это вещи, которые можно использовать только в школе",
                            "Личная собственность - это вещи, которые можно брать только у друзей"],
                "correct_answer": "Личная собственность - это вещи, которые принадлежат человеку",
                "category": 1
            },
            {
                'id': 6,
                'number': 6,
                "question": "Что такое кража?",
                "answers": ["Кража - это когда человек берет чужие вещи без разрешения",
                            "Кража - это когда человек берет чужие вещи и не возвращает их",
                            "Кража - это когда человек берет чужие вещи и продает их",
                            "Все варианты ответов верны"],
                "correct_answer": "Все варианты ответов верны",
                "category": 1
            },
            {
                'id': 7,
                'number': 7,
                "question": "Что такое договор и когда его заключают?",
                "answers": ["Договор - это когда два человека договариваются о чем-то",
                            "Договор - это когда два человека заключают сделку",
                            "Договор - это когда два человека обещают друг другу что-то",
                            "Договор - это когда два человека подписывают документ"],
                "correct_answer": "Договор - это когда два человека договариваются о чем-то",
                "category": 1
            },
            {
                'id': 8,
                'number': 8,
                "question": "Что такое уважение к старшим и почему это важно?",
                "answers": ["Уважение к старшим - это когда дети слушают и уважают взрослых",
                            "Уважение к старшим - это когда дети делают все, что им говорят взрослые",
                            "Уважение к старшим - это когда дети не спорят со взрослыми",
                            "Уважение к старшим - это когда дети не разговаривают со взрослыми"],
                "correct_answer": "Уважение к старшим - это когда дети слушают и уважают взрослых",
                "category": 1
            },
            {
                'id': 9,
                'number': 9,
                "question": "Что такое честность и почему это важно?",
                "answers": ["Честность - это когда человек говорит правду",
                            "Честность - это когда человек не обманывает других",
                            "Честность - это когда человек не скрывает свои ошибки",
                            "Честность - это когда человек не скрывает свои чувства"],
                "correct_answer": "Честность - это когда человек не обманывает других",
                "category": 1
            },
            {
                'id': 10,
                'number': 10,
                "question": "Что такое ответственность?",
                "answers": ["Ответственность - это когда человек отвечает за свои поступки",
                            "Ответственность - это когда человек выполняет свои обязанности",
                            "Ответственность - это когда человек не нарушает правила",
                            "Ответственность - это когда человек не делает ошибок"],
                "correct_answer": "Ответственность - это когда человек отвечает за свои поступки",
                "category": 1
            },
            {
                'id': 11,
                'number': 1,
                "question": "Что такое право?",
                "answers": ["Набор правил, которые нужно соблюдать",
                            "Система законов и правил, которые регулируют поведение людей",
                            "Совокупность личных прав и обязанностей каждого человека",
                            "Способность делать все, что хочется"],
                "correct_answer": "Система законов и правил, которые регулируют поведение людей",
                "category": 2
            },
            {
                'id': 12,
                'number': 2,
                "question": "Какие права и обязанности есть у детей?",
                "answers": ["Право на образование и обязанность учиться",
                            "Право на игру и обязанность играть",
                            "Право на свободу и обязанность быть свободным",
                            "Право на голосование и обязанность выкидывать мусор"],
                "correct_answer": "Право на образование и обязанность учиться",
                "category": 2
            },
            {
                'id': 13,
                'number': 3,
                "question": "Что такое закон?",
                "answers": ["Набор правил, которые нужно соблюдать",
                            "Система законов и правил, которые регулируют поведение людей",
                            "Совокупность личных прав и обязанностей каждого человека",
                            "Способность делать все, что хочется"],
                "correct_answer": "Система законов и правил, которые регулируют поведение людей",
                "category": 2
            },
            {
                'id': 14,
                'number': 4,
                "question": "Какие правила поведения в школе ты знаешь?",
                "answers": ["Не бегать по коридорам,\nНе драться",
                            "Не кричать на уроках,\nНе брать чужие вещи",
                            "Не курить в школе,\nНе приходить в школу в грязной одежде",
                            "Все варианты ответов верны"],
                "correct_answer": "Все варианты ответов верны",
                "category": 2
            },
            {
                'id': 15,
                'number': 5,
                "question": "Что такое личная собственность?",
                "answers": ["Личная собственность - это вещи, которые принадлежат человеку",
                            "Личная собственность - это вещи, которые можно брать без разрешения",
                            "Личная собственность - это вещи, которые можно использовать только в школе",
                            "Личная собственность - это вещи, которые можно брать только у друзей"],
                "correct_answer": "Личная собственность - это вещи, которые принадлежат человеку",
                "category": 2
            },
            {
                'id': 16,
                'number': 6,
                "question": "Что такое кража и почему это плохо?",
                "answers": ["Кража - это когда человек берет чужие вещи без разрешения",
                            "Кража - это когда человек берет чужие вещи и не возвращает их",
                            "Кража - это когда человек берет чужие вещи и продает их",
                            "Все варианты ответов верны"],
                "correct_answer": "Все варианты ответов верны",
                "category": 2
            },
            {
                'id': 17,
                'number': 7,
                "question": "Что такое договор и когда его заключают?",
                "answers": ["Договор - это когда два человека договариваются о чем-то",
                            "Договор - это когда два человека заключают сделку",
                            "Договор - это когда два человека обещают друг другу что-то",
                            "Договор - это когда два человека подписывают документ"],
                "correct_answer": "Договор - это когда два человека договариваются о чем-то",
                "category": 2
            },
            {
                'id': 18,
                'number': 8,
                "question": "Что такое уважение к старшим и почему это важно?",
                "answers": ["Уважение к старшим - это когда дети слушают и уважают взрослых",
                            "Уважение к старшим - это когда дети делают все, что им говорят взрослые",
                            "Уважение к старшим - это когда дети не спорят со взрослыми",
                            "Уважение к старшим - это когда дети не разговаривают со взрослыми"],
                "correct_answer": "Уважение к старшим - это когда дети слушают и уважают взрослых",
                "category": 2
            },
            {
                'id': 19,
                'number': 9,
                "question": "Что такое честность?",
                "answers": ["Честность - это когда человек говорит правду",
                            "Честность - это когда человек не обманывает других",
                            "Честность - это когда человек не скрывает свои ошибки",
                            "Честность - это когда человек не скрывает свои чувства"],
                "correct_answer": "Честность - это когда человек не обманывает других",
                "category": 2
            },
            {
                'id': 20,
                'number': 10,
                "question": "Что такое ответственность?",
                "answers": ["Ответственность - это когда человек отвечает за свои поступки",
                            "Ответственность - это когда человек выполняет свои обязанности",
                            "Ответственность - это когда человек не нарушает правила",
                            "Ответственность - это когда человек не делает ошибок"],
                "correct_answer": "Ответственность - это когда человек отвечает за свои поступки",
                "category": 2
            },
            {
                'id': 21,
                'number': 1,
                "question": "Что такое право?",
                "answers": ["Система правил, регулирующих поведение людей",
                            "Набор законов, установленных государством",
                            "Совокупность моральных норм и ценностей",
                            "Кодекс поведения, принятый обществом"],
                "correct_answer": "Система правил, регулирующих поведение людей",
                "category": 3
            },
            {
                'id': 22,
                'number': 2,
                "question": "Какие основные отрасли права существуют?",
                "answers": ["Гражданское право,\nУголовное право",
                            "Административное право,\nСемейное право",
                            "Трудовое право,\nЭкологическое право",
                            "Все варианты ответов верны"],
                "correct_answer": "Все варианты ответов верны",
                "category": 3
            },
            {
                'id': 23,
                'number': 3,
                "question": "Что такое Конституция?",
                "answers": ["Основной закон государства",
                            "Кодекс поведения граждан",
                            "Свод правил для чиновников",
                            "Устав политической партии"],
                "correct_answer": "Основной закон государства",
                "category": 3
            },
            {
                'id': 24,
                'number': 4,
                "question": "Какие права и свободы гарантированы Конституцией РФ?",
                "answers": ["Право на жизнь,\nПраво на свободу слова",
                            "Право на образование,\nПраво на свободу передвижения",
                            "Право на труд,\nПраво на охрану здоровья",
                            "Все варианты ответов верны"],
                "correct_answer": "Все варианты ответов верны",
                "category": 3
            },
            {
                'id': 25,
                'number': 5,
                "question": "Что такое гражданство?",
                "answers": ["Статус гражданина определенного государства",
                            "Наличие паспорта гражданина",
                            "Право на участие в выборах",
                            "Наличие гражданских прав и обязанностей"],
                "correct_answer": "Статус гражданина определенного государства",
                "category": 3
            },
            {
                'id': 26,
                'number': 6,
                "question": "Что такое юридическая ответственность?",
                "answers": ["Обязанность лица нести наказание за совершенное правонарушение",
                            "Возможность гражданина обратиться в суд",
                            "Обязанность государства защищать права и свободы граждан",
                            "Система наказаний за нарушение законов"],
                "correct_answer": "Обязанность лица нести наказание за совершенное правонарушение",
                "category": 3
            },
            {
                'id': 27,
                'number': 7,
                "question": "Что такое административное правонарушение? (Укажите НЕВЕРНЫЙ ответ)",
                "answers": ["Нарушение правил дорожного движения",
                            "Нарушение общественного порядка",
                            "Нарушение трудовой дисциплины",
                            "Нарушение правил пожарной безопасности"],
                "correct_answer": "Нарушение трудовой дисциплины",
                "category": 3
            },
            {
                'id': 28,
                'number': 8,
                "question": "Что такое уголовное преступление?",
                "answers": ["Нарушение уголовного кодекса,\nНасилие над личностью",
                            "Кража,\nУбийство",
                            "Мошенничество",
                            "Все варианты ответов верны"],
                "correct_answer": "Все варианты ответов верны",
                "category": 3
            },
            {
                'id': 29,
                'number': 9,
                "question": "Что такое гражданский процесс?",
                "answers": ["Разбирательство в суде по гражданским делам",
                            "Разбирательство в суде по уголовным делам",
                            "Разбирательство в суде по административным делам",
                            "Разбирательство в суде по трудовым спорам"],
                "correct_answer": "Разбирательство в суде по гражданским делам",
                "category": 3
            },
            {
                'id': 30,
                'number': 10,
                "question": "Что такое трудовое право?",
                "answers": ["Совокупность норм, регулирующих трудовые отношения",
                            "Совокупность норм, регулирующих отношения между работодателем и работником",
                            "Совокупность норм, регулирующих отношения между работником и государством",
                            "Все варианты ответов верны"],
                "correct_answer": "Все варианты ответов верны",
                "category": 3
            }
        ]

        # Подготовка данных для множественной вставки
        data = [(question['id'], question['number'], question['question'], *question['answers'],
                 question['correct_answer'], question['category']) for question in questions_base]

        try:
            self.cursor.executemany("INSERT OR REPLACE INTO questions VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?)", data)
            self.connection.commit()
        except sqlite3.Error as e:
            print(f"Ошибка при вставке данных: {e}")

    def is_database_empty(self):
        """
        Проверяет, пуста ли база данных.
        :return: True, если база данных пуста, и False в противном случае.
        """
        query = "SELECT COUNT(*) FROM users"
        self.cursor.execute(query)
        count = self.cursor.fetchone()[0]
        return count == 0

    def update_user_data(self, column_name, value, user_id):
        """
        Обновляет данные пользователя в указанном столбце.
        :param column_name: Имя столбца для обновления.
        :param value: Новое значение для столбца.
        :param user_id: ID пользователя, данные которого нужно обновить.
        """
        query = f"UPDATE users SET {column_name} = ? WHERE user_id = ?"
        self.cursor.execute(query, (value, user_id))
        self.connection.commit()

    def select_from_users_table(self, column_name, user_id):
        """
        Возвращает значение из базы данных из таблицы users по заданному столбцу и user_id.
        :param column_name: Имя столбца, значение которого нужно извлечь.
        :param user_id: ID пользователя.
        :return: Значение из указанного столбца для заданного user_id.
        """
        query = f"SELECT {column_name} FROM users WHERE user_id = ?"
        self.cursor.execute(query, (user_id,))
        result = self.cursor.fetchone()
        if result:
            # Если результат найден, возвращаем значение из указанного столбца
            return result[0]
        else:
            # Если результат не найден, возвращаем None или любое другое значение по умолчанию
            return None

    def select_columns_from_users_table(self, column_names: list[str], user_id: int):
        """
        Функция для выбора значений из нескольких столбцов таблицы users по user_id.
        :param column_names: Список имен столбцов, значения которых нужно выбрать.
        :param user_id: Значение user_id для фильтрации.
        :return: Список значений из указанных столбцов для заданного user_id.
        """
        # Формируем строку запроса динамически
        query = f"SELECT {', '.join(column_names)} FROM users WHERE user_id = ?"
        # Выполняем запрос с переданным user_id
        self.cursor.execute(query, (user_id,))
        # Получаем результат запроса
        result = self.cursor.fetchone()
        return result

    def select_question(self, number, category):
        """
        Возвращает значение из базы данных из таблицы questions из колонки question,
        где number и category равны заданным значениям.
        :param number: Номер вопроса.
        :param category: Категория вопроса.
        :return: Значение из колонки correct_answer для заданного вопроса и категории.
        """
        query = "SELECT question FROM questions WHERE number = ? AND category = ?"
        self.cursor.execute(query, (number, category))
        result = self.cursor.fetchone()
        if result:
            # Если результат найден, возвращаем значение correct_answer
            return result[0]
        else:
            # Если результат не найден, возвращаем None или любое другое значение по умолчанию
            return None

    def select_correct_answer(self, number, category):
        """
        Возвращает значение правильного ответа из таблицы questions из колонки correct_answer,
        где number и category равны заданным значениям.
        :param number: Номер вопроса.
        :param category: Категория вопроса.
        :return: Значение из колонки correct_answer для заданного вопроса и категории.
        """
        query = "SELECT correct_answer FROM questions WHERE number = ? AND category = ?"
        self.cursor.execute(query, (number, category))
        result = self.cursor.fetchone()
        if result:
            # Если результат найден, возвращаем значение correct_answer
            return result[0]
        else:
            # Если результат не найден, возвращаем None или любое другое значение по умолчанию
            return None

    def get_answers_from_db(self, category, number):
        """
        Извлекает значения полей answer1, answer2, answer3, answer4 из базы данных
        для заданной категории и номера.
        :param category: Категория вопроса.
        :param number: Номер вопроса.
        :return: Кортеж со значениями полей answer1, answer2, answer3, answer4.
        """
        query = "SELECT answer1, answer2, answer3, answer4 FROM questions WHERE category = ? AND number = ?"
        self.cursor.execute(query, (category, number))
        result = self.cursor.fetchone()
        if result:
            # Возвращаем кортеж с значениями полей answer1, answer2, answer3, answer4
            return result
        else:
            # Если результат не найден, возвращаем None или любое другое значение по умолчанию
            return None
